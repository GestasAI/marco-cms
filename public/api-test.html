<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marco CMS - API Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Marco CMS - API Test Suite</h1>
            <p class="subtitle">Prueba de conectividad con GestasAI API</p>
        </div>

        <!-- Test 1: Manifest -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Cargar Manifest</h2>
            <button onclick="testManifest()">Cargar Manifest Local</button>
            <div id="manifest-result"></div>
        </div>

        <!-- Test 2: Auth API -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Test de Autenticaci√≥n</h2>
            <div class="input-group">
                <label>Email:</label>
                <input type="email" id="auth-email" value="admin@gestasai.com" placeholder="tu@email.com">
            </div>
            <div class="input-group">
                <label>Password:</label>
                <input type="password" id="auth-password" value="" placeholder="contrase√±a">
            </div>
            <button onclick="testAuth()">Test Login API</button>
            <button onclick="testAuthMe()">Test /auth/me (requiere token)</button>
            <div id="auth-result"></div>
        </div>

        <!-- Test 3: Bridge API -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Test de Universal API Bridge</h2>
            <button onclick="testBridgeQuery()">Test Query (Leer)</button>
            <button onclick="testBridgeInsert()">Test Insert (Crear)</button>
            <button onclick="testBridgeUpdate()">Test Update (Actualizar)</button>
            <button onclick="testBridgeDelete()">Test Delete (Eliminar)</button>
            <div id="bridge-result"></div>
        </div>

        <!-- Test 4: Plugin Registration -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Test de Registro de Plugin</h2>
            <button onclick="testPluginRegister()">Registrar Marco CMS</button>
            <button onclick="testPluginsList()">Listar Plugins</button>
            <div id="plugin-result"></div>
        </div>

        <!-- Test 5: Custom Request -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Request Personalizado</h2>
            <div class="input-group">
                <label>M√©todo:</label>
                <select id="custom-method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </div>
            <div class="input-group">
                <label>Endpoint:</label>
                <input type="text" id="custom-endpoint" value="/api/bridge/query" placeholder="/api/endpoint">
            </div>
            <div class="input-group">
                <label>Body (JSON):</label>
                <textarea id="custom-body">{"collection": "marco_content"}</textarea>
            </div>
            <button onclick="testCustomRequest()">Enviar Request</button>
            <div id="custom-result"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let authToken = localStorage.getItem('marco_token');

        function showResult(elementId, data, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function testManifest() {
            try {
                const response = await fetch('/manifest.json');
                const data = await response.json();
                showResult('manifest-result', {
                    status: 'SUCCESS',
                    manifest: data
                }, 'success');
            } catch (error) {
                showResult('manifest-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.data?.token || data.token;
                    if (authToken) {
                        localStorage.setItem('marco_token', authToken);
                    }
                    showResult('auth-result', {
                        status: 'SUCCESS',
                        statusCode: response.status,
                        data: data,
                        token_saved: !!authToken
                    }, 'success');
                } else {
                    showResult('auth-result', {
                        status: 'ERROR',
                        statusCode: response.status,
                        error: data
                    }, 'error');
                }
            } catch (error) {
                showResult('auth-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testAuthMe() {
            if (!authToken) {
                showResult('auth-result', {
                    status: 'ERROR',
                    error: 'No hay token. Haz login primero.'
                }, 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                showResult('auth-result', {
                    status: response.ok ? 'SUCCESS' : 'ERROR',
                    statusCode: response.status,
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('auth-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testBridgeQuery() {
            try {
                const response = await fetch(`${API_URL}/api/bridge/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        collection: 'marco_content',
                        orderBy: { created_at: 'DESC' },
                        limit: 10
                    })
                });

                const data = await response.json();
                showResult('bridge-result', {
                    status: response.ok ? 'SUCCESS' : 'ERROR',
                    statusCode: response.status,
                    endpoint: '/api/bridge/query',
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('bridge-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testBridgeInsert() {
            try {
                const response = await fetch(`${API_URL}/api/bridge/insert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    },
                    body: JSON.stringify({
                        collection: 'marco_content',
                        document: {
                            title: 'Test desde API Test Suite',
                            content: 'Este es un contenido de prueba creado desde el test suite',
                            status: 'draft',
                            created_at: new Date().toISOString()
                        }
                    })
                });

                const data = await response.json();
                showResult('bridge-result', {
                    status: response.ok ? 'SUCCESS' : 'ERROR',
                    statusCode: response.status,
                    endpoint: '/api/bridge/insert',
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('bridge-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testBridgeUpdate() {
            showResult('bridge-result', {
                status: 'INFO',
                message: 'Primero necesitas un ID de contenido. Usa Query para obtener uno.'
            }, 'info');
        }

        async function testBridgeDelete() {
            showResult('bridge-result', {
                status: 'INFO',
                message: 'Primero necesitas un ID de contenido. Usa Query para obtener uno.'
            }, 'info');
        }

        async function testPluginRegister() {
            try {
                const manifestResponse = await fetch('/manifest.json');
                const manifest = await manifestResponse.json();

                const response = await fetch(`${API_URL}/api/plugins/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...manifest,
                        status: 'ONLINE',
                        last_seen: new Date().toISOString()
                    })
                });

                const data = await response.json();
                showResult('plugin-result', {
                    status: response.ok ? 'SUCCESS' : 'ERROR',
                    statusCode: response.status,
                    endpoint: '/api/plugins/register',
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('plugin-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testPluginsList() {
            try {
                const response = await fetch(`${API_URL}/api/plugins`, {
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    }
                });

                const data = await response.json();
                showResult('plugin-result', {
                    status: response.ok ? 'SUCCESS' : 'ERROR',
                    statusCode: response.status,
                    endpoint: '/api/plugins',
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('plugin-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        async function testCustomRequest() {
            const method = document.getElementById('custom-method').value;
            const endpoint = document.getElementById('custom-endpoint').value;
            const bodyText = document.getElementById('custom-body').value;

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    }
                };

                if (method !== 'GET' && bodyText) {
                    options.body = bodyText;
                }

                const response = await fetch(`${API_URL}${endpoint}`, options);
                const data = await response.json();

                showResult('custom-result', {
                    status: response.ok ? 'SUCCESS' : 'ERROR',
                    statusCode: response.status,
                    method: method,
                    endpoint: endpoint,
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('custom-result', {
                    status: 'ERROR',
                    error: error.message
                }, 'error');
            }
        }

        // Auto-load manifest on page load
        window.addEventListener('load', () => {
            testManifest();
            if (authToken) {
                showResult('auth-result', {
                    status: 'INFO',
                    message: 'Token encontrado en localStorage',
                    token: authToken.substring(0, 20) + '...'
                }, 'info');
            }
        });
    </script>
</body>
</html>
